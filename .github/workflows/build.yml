name: Build VideoTranslator

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€vå¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘

permissions:
  contents: write

jobs:
  build-macos:
    name: Build macOS
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install PyQt6 pyinstaller
    
    - name: Build macOS app
      run: |
        pyinstaller --name="VideoTranslator" \
          --windowed \
          --add-data="s1_transcribe.py:." \
          --add-data="s2_translate.py:." \
          --add-data="s3_generate_voiceover.py:." \
          --add-data="s5_burn_subtitles_simple.py:." \
          --add-data="video_processor.py:." \
          --add-data="config_manager.py:." \
          --add-data="multilang_fast_parallel.py:." \
          --add-data="README_GUI.md:." \
          --hidden-import=faster_whisper \
          --hidden-import=PyQt6 \
          --hidden-import=PyQt6.QtCore \
          --hidden-import=PyQt6.QtGui \
          --hidden-import=PyQt6.QtWidgets \
          --hidden-import=edge_tts \
          --hidden-import=gtts \
          --hidden-import=googletrans \
          --hidden-import=srt \
          --collect-all=faster_whisper \
          --collect-all=whisper \
          --collect-all=edge_tts \
          --collect-all=gtts \
          gui_app_v1.py
    
    - name: Create ZIP
      run: |
        cd dist
        zip -r ../VideoTranslator_macOS.zip VideoTranslator.app
        cd ..
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: VideoTranslator-macOS
        path: VideoTranslator_macOS.zip

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install PyQt6 pyinstaller
    
    - name: Build Windows app
      run: |
        pyinstaller --name="VideoTranslator" `
          --windowed `
          --add-data="s1_transcribe.py;." `
          --add-data="s2_translate.py;." `
          --add-data="s3_generate_voiceover.py;." `
          --add-data="s5_burn_subtitles_simple.py;." `
          --add-data="video_processor.py;." `
          --add-data="config_manager.py;." `
          --add-data="multilang_fast_parallel.py;." `
          --add-data="README_GUI.md;." `
          --hidden-import=faster_whisper `
          --hidden-import=PyQt6 `
          --hidden-import=PyQt6.QtCore `
          --hidden-import=PyQt6.QtGui `
          --hidden-import=PyQt6.QtWidgets `
          --hidden-import=edge_tts `
          --hidden-import=gtts `
          --hidden-import=googletrans `
          --hidden-import=srt `
          --collect-all=faster_whisper `
          --collect-all=whisper `
          --collect-all=edge_tts `
          --collect-all=gtts `
          gui_app_v1.py
    
    - name: Create usage guide
      run: |
        echo "====================================" > dist/VideoTranslator/ä½¿ç”¨è¯´æ˜.txt
        echo "VideoTranslator Windowsç‰ˆä½¿ç”¨æŒ‡å—" >> dist/VideoTranslator/ä½¿ç”¨è¯´æ˜.txt
        echo "====================================" >> dist/VideoTranslator/ä½¿ç”¨è¯´æ˜.txt
        echo "" >> dist/VideoTranslator/ä½¿ç”¨è¯´æ˜.txt
        echo "è¿è¡Œæ–¹æ³•ï¼šåŒå‡» VideoTranslator.exe å¯åŠ¨" >> dist/VideoTranslator/ä½¿ç”¨è¯´æ˜.txt
        echo "" >> dist/VideoTranslator/ä½¿ç”¨è¯´æ˜.txt
        echo "ç³»ç»Ÿè¦æ±‚ï¼šWindows 10/11 (64ä½) + FFmpeg" >> dist/VideoTranslator/ä½¿ç”¨è¯´æ˜.txt
        echo "" >> dist/VideoTranslator/ä½¿ç”¨è¯´æ˜.txt
        echo "å®‰è£…FFmpegï¼šhttps://github.com/BtbN/FFmpeg-Builds/releases" >> dist/VideoTranslator/ä½¿ç”¨è¯´æ˜.txt
    
    - name: Create ZIP
      run: |
        Compress-Archive -Path "dist\VideoTranslator" -DestinationPath "VideoTranslator_Windows.zip"
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: VideoTranslator-Windows
        path: VideoTranslator_Windows.zip

  release:
    name: Create Release
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    
    steps:
    - name: Download macOS artifact
      uses: actions/download-artifact@v4
      with:
        name: VideoTranslator-macOS
    
    - name: Download Windows artifact
      uses: actions/download-artifact@v4
      with:
        name: VideoTranslator-Windows
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          VideoTranslator_macOS.zip
          VideoTranslator_Windows.zip
        body: |
          ## ğŸ‰ VideoTranslator ${{ github.ref_name }}
          
          ### ğŸ“¦ ä¸‹è½½
          
          - **Macç”¨æˆ·**: ä¸‹è½½ `VideoTranslator_macOS.zip`
          - **Windowsç”¨æˆ·**: ä¸‹è½½ `VideoTranslator_Windows.zip`
          
          ### âœ¨ åŠŸèƒ½ç‰¹æ€§
          
          - âœ… æ”¯æŒ16ç§è¯­è¨€ç¿»è¯‘
          - âœ… è‡ªåŠ¨å­—å¹•æå–ï¼ˆWhisper AIï¼‰
          - âœ… æ™ºèƒ½é…éŸ³ç”Ÿæˆï¼ˆEdge TTS + gTTSï¼‰
          - âœ… å¹¶è¡Œå¤„ç†æå‡é€Ÿåº¦
          - âœ… éŸ³é‡æ ‡å‡†åŒ–
          
          ### ğŸ“ ä½¿ç”¨è¯´æ˜
          
          #### Macç”¨æˆ·
          1. è§£å‹ `VideoTranslator_macOS.zip`
          2. æ‹–æ‹½ `VideoTranslator.app` åˆ°åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹
          3. å®‰è£…FFmpeg: `brew install ffmpeg`
          4. å¯åŠ¨VideoTranslator
          
          #### Windowsç”¨æˆ·
          1. è§£å‹ `VideoTranslator_Windows.zip`
          2. å®‰è£…FFmpegï¼ˆå‚è€ƒå‹ç¼©åŒ…å†…è¯´æ˜ï¼‰
          3. åŒå‡» `VideoTranslator.exe`
          
          ### âš ï¸ æ³¨æ„äº‹é¡¹
          
          - é¦–æ¬¡è¿è¡Œéœ€è¦ä¸‹è½½Whisperæ¨¡å‹ï¼ˆ~150MBï¼‰
          - Macé¦–æ¬¡è¿è¡Œå¯èƒ½æç¤º"æ— æ³•éªŒè¯å¼€å‘è€…"ï¼Œè¯·åœ¨"å®‰å…¨æ€§ä¸éšç§"ä¸­å…è®¸
          - Windowsé¦–æ¬¡è¿è¡Œå¯èƒ½è¢«Defenderæ‹¦æˆªï¼Œç‚¹å‡»"æ›´å¤šä¿¡æ¯" â†’ "ä»è¦è¿è¡Œ"
          
          ### ğŸ› é—®é¢˜åé¦ˆ
          
          å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·åœ¨Issuesä¸­åé¦ˆ
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
